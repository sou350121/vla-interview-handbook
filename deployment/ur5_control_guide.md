# UR5/UR5e Python æ§åˆ¶å®æˆ˜æŒ‡å— (Linux)

> **å®æˆ˜èƒŒæ™¯**: åœ¨ VLA (Vision-Language-Action) ç ”ç©¶ä¸éƒ¨ç½²ä¸­ï¼ŒUR5/UR5e æ˜¯æœ€å¸¸è§çš„éªŒè¯å¹³å°ã€‚ç›¸æ¯”äºåºå¤§çš„ ROS ä½“ç³»ï¼Œç›´æ¥ä½¿ç”¨ Python æ¥å£è¿›è¡Œè½»é‡çº§æ§åˆ¶å¾€å¾€æ›´é«˜æ•ˆï¼Œå°¤å…¶æ˜¯åœ¨æ•°æ®é‡‡é›†å’Œæ¨¡å‹æ¨ç†é˜¶æ®µã€‚

---

## 1. ç¯å¢ƒå‡†å¤‡ (Linux Setup)

### 1.1 ç³»ç»Ÿè¦æ±‚
- **OS**: Ubuntu 20.04 / 22.04 LTS (æ¨è)
- **Kernel**: æ ‡å‡†å†…æ ¸å³å¯ï¼Œä½†åœ¨é«˜é¢‘æ§åˆ¶ (500Hz+) ä¸‹å»ºè®®ä½¿ç”¨ **PREEMPT_RT** å®æ—¶å†…æ ¸ä»¥å‡å°‘æŠ–åŠ¨ã€‚
- **Network**: **æœ‰çº¿è¿æ¥**æ˜¯å¿…é¡»çš„ã€‚Wi-Fi çš„æŠ–åŠ¨ä¼šå¯¼è‡´ `Protective Stop`ã€‚

### 1.2 ç½‘ç»œé…ç½®
UR æ§åˆ¶å™¨é€šå¸¸é™æ€ IP (å¦‚ `192.168.1.100`)ã€‚PC ç«¯éœ€é…ç½®åŒç½‘æ®µé™æ€ IPã€‚

```bash
# /etc/netplan/01-network-manager-all.yaml (ç¤ºä¾‹)
network:
  version: 2
  ethernets:
    enp3s0:  # ä½ çš„ç½‘å¡åï¼Œç”¨ ip addr æŸ¥çœ‹
      dhcp4: no
      addresses:
        - 192.168.1.101/24
```
`sudo netplan apply` ç”Ÿæ•ˆã€‚
**éªŒè¯**: `ping 192.168.1.100` å»¶è¿Ÿåº” < 0.5ms ä¸”æ— ä¸¢åŒ…ã€‚

---

## 2. Python åº“é€‰å‹

### 2.1 `ur_rtde` (â­â­â­ å¼ºçƒˆæ¨è)
- **æ¥æº**: SDU Robotics (University of Southern Denmark)
- **ç‰¹ç‚¹**: åŸºäº C++ ç»‘å®šï¼Œæ€§èƒ½æé«˜ï¼Œå®˜æ–¹ç»´æŠ¤ï¼Œæ”¯æŒ 500Hz é€šä¿¡ã€‚
- **å®‰è£…**: `pip install ur_rtde`

### 2.2 `python-urx` (âš ï¸ å·²è¿‡æ—¶)
- **ç‰¹ç‚¹**: çº¯ Python å®ç°ï¼Œç®€å•æ˜“æ‡‚ï¼Œä½†**å·²åœæ­¢ç»´æŠ¤**å¤šå¹´ã€‚
- **ç¼ºç‚¹**: åœ¨ Polyscope 5.x+ ä¸Šä¸ç¨³å®šï¼Œä¸æ”¯æŒ RTDE é«˜é¢‘æ¥å£ã€‚
- **å»ºè®®**: ä»…ç”¨äºç»´æŠ¤æ—§ä»£ç ï¼Œæ–°é¡¹ç›®å‹¿ç”¨ã€‚

---

## 3. å®æˆ˜ä»£ç æ¨¡å¼ (åŸºäº `ur_rtde`)

### 3.1 åŸºç¡€è¿æ¥ä¸çŠ¶æ€è¯»å–
```python
import rtde_receive
import rtde_control
import time

ROBOT_IP = "192.168.1.100"

# 1. è¿æ¥æ¥æ”¶æ¥å£ (è¯»å–çŠ¶æ€)
rtde_r = rtde_receive.RTDEReceiveInterface(ROBOT_IP)
# 2. è¿æ¥æ§åˆ¶æ¥å£ (å‘é€æŒ‡ä»¤)
rtde_c = rtde_control.RTDEControlInterface(ROBOT_IP)

# è¯»å–å½“å‰å…³èŠ‚è§’åº¦ (rad)
actual_q = rtde_r.getActualQ()
# è¯»å–å½“å‰æœ«ç«¯ä½å§¿ (TCP: x, y, z, rx, ry, rz)
actual_tcp = rtde_r.getActualTCPPose()

print(f"Current Joint: {actual_q}")
```

### 3.2 è¿åŠ¨æ§åˆ¶æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | æŒ‡ä»¤ | é€‚ç”¨åœºæ™¯ | å¤‡æ³¨ |
| :--- | :--- | :--- | :--- |
| **MoveJ** | `moveJ(q, speed, accel)` | ç‚¹åˆ°ç‚¹ç§»åŠ¨ (å› Home) | å…³èŠ‚ç©ºé—´æ’å€¼ï¼Œè·¯å¾„éç›´çº¿ |
| **MoveL** | `moveL(pose, speed, accel)` | æŠ“å–/æ’æ‹” | ç¬›å¡å°”ç©ºé—´ç›´çº¿è¿åŠ¨ |
| **ServoJ** | `servoJ(q, ...)` | **VLAæ¨¡å‹æ¨ç†/é¥æ“ä½œ** | å®æ—¶æµå¼æ§åˆ¶ï¼Œå»¶è¿Ÿæœ€ä½ |
| **SpeedJ** | `speedJ(qd, ...)` | è§†è§‰ä¼ºæœ/æ‘‡æ†æ§åˆ¶ | é€Ÿåº¦æ§åˆ¶ï¼Œå¹³æ»‘ä½†éœ€ç§¯åˆ† |

#### å®æˆ˜ï¼šä½¿ç”¨ ServoJ è¿›è¡Œå¹³æ»‘è·Ÿéš (VLA å¸¸ç”¨)
æ¨¡å‹é€šå¸¸ä»¥ 10Hz-50Hz è¾“å‡ºç›®æ ‡å…³èŠ‚è§’ï¼Œç›´æ¥ `moveJ` ä¼šå¡é¡¿ï¼Œå¿…é¡»ç”¨ `servoJ`ã€‚

```python
def smooth_servo_loop(target_trajectory):
    # å‚æ•°è°ƒä¼˜æ˜¯å…³é”®
    # velocity/acceleration: é™åˆ¶æœ€å¤§å€¼é˜²æ€¥åœ
    # lookahead_time: è¶Šå°å“åº”è¶Šå¿«ä½†æ˜“æŠ–åŠ¨ (0.03-0.2s)
    # gain: æ¯”ä¾‹å¢ç›Š (100-500)
    
    dt = 1.0/500  # 2ms æ§åˆ¶å‘¨æœŸ
    
    for target_q in target_trajectory:
        start = time.time()
        
        rtde_c.servoJ(
            target_q, 
            velocity=0.5, 
            acceleration=0.5, 
            dt=dt, 
            lookahead_time=0.1, 
            gain=300
        )
        
        # ä¸¥æ ¼æ§åˆ¶å¾ªç¯æ—¶é—´
        diff = time.time() - start
        if diff < dt:
            time.sleep(dt - diff)
            
    rtde_c.servoStop()
    rtde_c.stopScript()
```

### 3.3 IO æ§åˆ¶ (å¤¹çˆª/å¸ç›˜)
å¤§éƒ¨åˆ†å¤¹çˆª (Robotiq) æˆ–å¸ç›˜é€šè¿‡æ§åˆ¶å™¨çš„æ•°å­— IO è§¦å‘ã€‚

```python
# è®¾ç½®æ•°å­—è¾“å‡º DO0 ä¸ºé«˜ç”µå¹³ (ä¾‹å¦‚ï¼šé—­åˆå¤¹çˆª)
rtde_c.setStandardDigitalOut(0, True)

# è¯»å–æ•°å­—è¾“å…¥ DI0 (ä¾‹å¦‚ï¼šå¤¹çˆªåˆ°ä½ä¿¡å·)
state = rtde_r.getDigitalInState(0)
```

---

## 4. è¸©å‘ç»éªŒ (Troubleshooting)

### 4.1 ä¿æŠ¤æ€§åœæ­¢ (Protective Stop)
**ç°è±¡**: æœºå™¨äººçªç„¶åœæ­¢ï¼Œç¤ºæ•™å™¨å¼¹çª—æŠ¥é”™ã€‚
**å¸¸è§åŸå› **:
1. **å¥‡å¼‚ç‚¹ (Singularity)**: ç»è¿‡è‚©å…³èŠ‚/è…•å…³èŠ‚å¥‡å¼‚åŒºåŸŸï¼Œå¯¼è‡´å…³èŠ‚é€Ÿåº¦æ— ç©·å¤§ã€‚
   - *è§£æ³•*: åœ¨è·¯å¾„è§„åˆ’å±‚å¢åŠ å¥‡å¼‚ç‚¹æ£€æµ‹ (`manipulability index`)ã€‚
2. **åŠ é€Ÿåº¦è¿‡å¤§**: æ¨¡å‹è¾“å‡ºçš„è½¨è¿¹ä¸å¹³æ»‘ï¼Œä¸¤å¸§ä¹‹é—´è·³å˜å¤ªå¤§ã€‚
   - *è§£æ³•*: è¾“å‡ºç«¯åŠ ä½é€šæ»¤æ³¢ (LPF) æˆ–æ’å€¼ã€‚
3. **è´Ÿè½½æœªè®¾ç½®**: æŠ“èµ·é‡ç‰©åæœªæ›´æ–° Payloadï¼ŒåŠ¨åŠ›å­¦æ¨¡å‹ä¸åŒ¹é…ã€‚
   - *è§£æ³•*: `rtde_c.setPayload(mass, cog)`

### 4.2 è‡ªåŠ¨å¤ä½è„šæœ¬
åœ¨æ— äººå€¼å®ˆæµ‹è¯•æ—¶ï¼Œè‡ªåŠ¨ä» Protective Stop æ¢å¤æ˜¯å¿…é¡»çš„ã€‚

```python
def try_recover():
    # æ£€æŸ¥æ˜¯å¦å¤„äºä¿æŠ¤æ€§åœæ­¢
    if rtde_r.isProtectiveStopped():
        print("Protective Stop detected! Attempting recovery...")
        # 1. è§£é”ä¿æŠ¤æ€§åœæ­¢
        rtde_c.unlockProtectiveStop() 
        # 2. é‡æ–°ä¸Šç”µå¹¶æ¾åˆ¹è½¦
        # æ³¨æ„: éœ€è¦è¶³å¤Ÿçš„å»¶æ—¶
        return True
    return False
```

### 4.3 å®æ—¶æ€§ä¸æŠ–åŠ¨
**ç°è±¡**: æœºå™¨äººåŠ¨ä½œä¸€å¡ä¸€å¡ã€‚
**åŸå› **: Python åƒåœ¾å›æ”¶ (GC) æˆ–ç½‘ç»œæŠ–åŠ¨å¯¼è‡´æ§åˆ¶å‘¨æœŸä¸ç¨³å®šã€‚
**ä¼˜åŒ–**:
- å…³é—­ GC: `gc.disable()` (åœ¨å…³é”®å¾ªç¯ä¸­)ã€‚
- ç»‘æ ¸: `taskset -c 0 python control.py`ã€‚
- **ä¸è¦åœ¨æ§åˆ¶å¾ªç¯ä¸­ print**: I/O æ˜¯æœ€å¤§çš„å»¶è¿Ÿæºã€‚

### 4.4 é•¿æ—¶é—´è¿è¡Œå‘çƒ­å¯¼è‡´æŠ–åŠ¨ (Thermal Jitter)

**ç°è±¡æè¿°**:
æœºå™¨äººè¿ç»­è¿è¡Œæ•°å°æ—¶ï¼ˆç‰¹åˆ«æ˜¯æ‰§è¡Œé«˜é¢‘ ServoJ æˆ–é‡è´Ÿè½½ä»»åŠ¡ï¼‰åï¼Œå…³èŠ‚ç”µæœºæ¸©åº¦å‡é«˜ï¼Œæœ«ç«¯å‡ºç°ç»†å¾®çš„é«˜é¢‘éœ‡é¢¤ï¼Œæˆ–è€…åœ¨ä½é€Ÿç›´çº¿è¿åŠ¨æ—¶æœ‰æ˜æ˜¾çš„â€œå¡é¡¿â€æ„Ÿï¼Œç”šè‡³å¯èƒ½è§¦å‘ `Joint Violation` æŠ¥é”™ã€‚

**åŸå› æ¨æ–­**:
1. **æ§åˆ¶å¢ç›Šè¿‡æ•æ„Ÿ**: ç³»ç»Ÿåœ¨é«˜å¢ç›Šï¼ˆHigh Gainï¼‰ä¸‹è¿è¡Œï¼Œå½“ç”µæœºå‘çƒ­å¯¼è‡´å†…éƒ¨æ¶¦æ»‘è„‚å˜ç¨€ã€æœºæ¢°é˜»å°¼å‡å°æ—¶ï¼ŒåŸæœ‰çš„æ§åˆ¶å‚æ•°ä¼šå˜å¾—è¿‡å†²ï¼ˆOvershootï¼‰ã€‚
2. **ç¼–ç å™¨çƒ­æ¼‚ç§»**: é«˜æ¸©å¯èƒ½å¹²æ‰°å…³èŠ‚å†…ç½®ç¼–ç å™¨çš„åé¦ˆç²¾åº¦ï¼Œå¯¼è‡´é—­ç¯æ§åˆ¶åœ¨ç›®æ ‡ç‚¹é™„è¿‘äº§ç”Ÿå¾®å°éœ‡è¡ã€‚
3. **çƒ­ä¿æŠ¤é™æµ**: æ§åˆ¶å™¨ä¸ºä¿æŠ¤ç”µæœºï¼Œå¯èƒ½ä¼šè°ƒæ•´ PWM é¢‘ç‡æˆ–é™æµï¼Œå¯¼è‡´åŠ›çŸ©è¾“å‡ºç¨³å®šæ€§ä¸‹é™ã€‚

**å»ºè®®è§£å†³æ–¹æ¡ˆ**:
- **å®æ—¶æ¸©æ§ç›‘æ§**: åœ¨ä»£ç ä¸­å¢åŠ æ¸©åº¦é¢„è­¦é€»è¾‘ã€‚
  ```python
  # è·å–å…³èŠ‚æ¸©åº¦ (1x6 åˆ—è¡¨)
  joint_temps = rtde_r.getJointTemperatures()
  if max(joint_temps) > 55.0:
      print(f"Warning: Joint temp high {max(joint_temps)}Â°C, reducing speed.")
  ```
- **åŠ¨æ€è°ƒæ•´å¢ç›Š**: å½“æ£€æµ‹åˆ°æ¸©åº¦å‡é«˜æ—¶ï¼Œé€‚å½“**é™ä½ `servoJ` çš„ `gain`**ï¼ˆä¾‹å¦‚ä» 300 é™è‡³ 150-200ï¼‰ï¼Œå¹¶ç¨å¾®**å¢åŠ  `lookahead_time`** ä»¥å¹³æ»‘è½¨è¿¹ã€‚
- **å¼ºåˆ¶å†·å´å‘¨æœŸ**: åœ¨ VLA æ¨¡å‹æµ‹è¯•ä¸­ï¼Œå»ºè®®æ¯è¿è¡Œ 45-60 åˆ†é’Ÿï¼Œå¼ºåˆ¶æœºå™¨äººå›åˆ° Home ç‚¹â€œä¼‘æ¯â€ 5 åˆ†é’Ÿï¼ˆä¿æŒæŠ±é—¸çŠ¶æ€ï¼‰ï¼Œé¿å…çƒ­é‡ç´¯ç§¯ã€‚

> [!CAUTION]
> ### âš ï¸ æ•°æ®é‡‡é›†ä¸€è‡´æ€§è­¦å‘Š (Data Collection Consistency)
> åœ¨è¿›è¡Œ **æ•°æ®é‡‡é›†ï¼ˆTeleoperation/Data Collectionï¼‰** æ—¶ï¼Œ**ä¸¥ç¦åŠ¨æ€è°ƒæ•´ `gain` å’Œ `lookahead_time`**ï¼
> *   **åæœ**: å¦‚æœæ•°æ®é›†ä¸­æ··åˆäº†ä¸åŒåŠ¨æ€ç‰¹æ€§çš„åŠ¨ä½œï¼ˆæœ‰çš„å¿«å“åº”ï¼Œæœ‰çš„æ…¢å“åº”ï¼‰ï¼ŒVLA æ¨¡å‹ä¼šå­¦åˆ°ä¸ä¸€è‡´çš„è¡Œä¸ºåˆ†å¸ƒï¼Œå¯¼è‡´è®­ç»ƒéš¾ä»¥æ”¶æ•›æˆ–æ¨ç†æ—¶äº§ç”Ÿå‰§çƒˆéœ‡è¡ã€‚
> *   **æ­£ç¡®åšæ³•**: 
>     1. é€‰å®šä¸€ç»„æœ€ä¼˜å‚æ•°ï¼ˆå¦‚ `gain=300`, `lookahead=0.1`ï¼‰åï¼Œåœ¨æ•´ä¸ªé‡‡é›†å‘¨æœŸå†…ä¿æŒä¸å˜ã€‚
>     2. å¦‚æœæœºå™¨äººå‘çƒ­å¯¼è‡´æŠ–åŠ¨æ— æ³•ç»§ç»­ï¼Œ**å¿…é¡»åœæ­¢é‡‡é›†å¹¶å¼ºåˆ¶å†·å´**ï¼Œè€Œä¸æ˜¯é€šè¿‡é™ä½å¢ç›Šæ¥â€œå¸¦ç—…å·¥ä½œâ€ã€‚
>     3. å§‹ç»ˆç¡®ä¿è®­ç»ƒæ—¶çš„ `servoJ` å‚æ•°ä¸æ¨ç†ï¼ˆInferenceï¼‰æ—¶å®Œå…¨ä¸€è‡´ã€‚

- **æ£€æŸ¥ Payload**: ç¡®ä¿ `setPayload` åŒ…å«å¤¹çˆªåŠç‰©ä½“çš„çœŸå®é‡å¿ƒï¼ˆCoGï¼‰ã€‚ä¸å‡†ç¡®çš„é‡å¿ƒä¼šå¯¼è‡´ç”µæœºæŒç»­è¾“å‡ºé¢å¤–æ‰­çŸ©ä»¥æŠµæ¶ˆé‡åŠ›ï¼Œä»è€Œå¿«é€Ÿå‘çƒ­ã€‚

---

## 5. è¿›é˜¶ï¼šç»“åˆ VLA æ¨¡å‹

åœ¨ VLA ç³»ç»Ÿä¸­ï¼Œé€šå¸¸æ¶æ„å¦‚ä¸‹ï¼š

1. **Inference çº¿ç¨‹**: GPU æ¨ç†ï¼Œè¾“å‡º `target_q` å†™å…¥é˜Ÿåˆ—ã€‚
2. **Control çº¿ç¨‹**: 500Hz ä»é˜Ÿåˆ—è¯»å–æœ€æ–° `target_q`ï¼Œæ‰§è¡Œ `servoJ`ã€‚

```python
import threading
import queue

q_queue = queue.Queue(maxsize=1)

def control_thread():
    while True:
        if not q_queue.empty():
            target = q_queue.get()
            rtde_c.servoJ(target, ..., lookahead_time=0.1)
        else:
            # é˜Ÿåˆ—ç©ºæ—¶ä¿æŒå½“å‰å§¿æ€ (é˜²æ­¢æ‰ç”µ)
            rtde_c.servoJ(rtde_r.getActualQ(), ...)
        time.sleep(0.002)

# å¯åŠ¨æ§åˆ¶çº¿ç¨‹
t = threading.Thread(target=control_thread)
t.start()

# ä¸»çº¿ç¨‹è·‘æ¨¡å‹
while True:
    img = camera.read()
    action = model.predict(img)
    q_queue.put(action)  # ä»…æ”¾å…¥æœ€æ–°åŠ¨ä½œ
```

---

## 6. SOTA æ¨¡å‹è¿ç§»å®æˆ˜ (Case Study: OneTwoVLA)

å°†è¿™ç±»åœ¨ 7-DOF Franka ä¸Šå¼€å‘çš„æ¨¡å‹è¿ç§»åˆ° UR5 æ—¶ï¼Œéœ€æ³¨æ„ï¼š

1.  **åŠ¨ä½œæ˜ å°„ (Action Remapping)**:
    *   æ¨¡å‹è¾“å‡ºé€šå¸¸ä¸º 7 ç»´ã€‚éœ€å‰¥ç¦» Franka çš„â€œè‚˜éƒ¨â€å…³èŠ‚ï¼ˆA4 æˆ– A7 å†—ä½™é¡¹ï¼‰ï¼Œæˆ–è€…åªä½¿ç”¨æœ«ç«¯ä½å§¿ï¼ˆPoseï¼‰è¿›è¡Œæ˜ å°„ã€‚
2.  **å¥‡å¼‚ç‚¹å¤„ç† (Singularity Management)**:
    *   UR5 çš„è…•éƒ¨å¥‡å¼‚ç‚¹æ¯” Franka æ›´å¤šã€‚å»ºè®®åœ¨æ¨¡å‹è¾“å‡ºååŠ ä¸€ä¸ªâ€œå®‰å…¨å›´æ â€é€»è¾‘ï¼šå¦‚æœè®¡ç®—å‡ºçš„ IK æ¥è¿‘å¥‡å¼‚ç‚¹ï¼ˆManipulability < 0.01ï¼‰ï¼Œå¼ºåˆ¶ä¸­æ–­å¹¶è§¦å‘æ¨¡å‹çš„æ¨ç†æ¨¡å¼ï¼ˆå¦‚ OneTwoVLA çš„ `[BOR]`ï¼‰ã€‚
3.  **åé¦ˆè¡¥å¿**:
    *   Franka æ‹¥æœ‰é«˜é¢‘åŠ›çŸ©åé¦ˆï¼Œè€Œ UR5 é»˜è®¤åé¦ˆè¾ƒæ…¢ã€‚åœ¨æ¨ç†æ—¶ï¼Œå»ºè®®å°† UR5 çš„ç”µæµï¼ˆCurrentï¼‰æˆ– TCP ä¼°ç®—åŠ›ï¼ˆTCP Wrenchï¼‰è¿›è¡Œæ ‡å‡†åŒ–åå–‚ç»™æ¨¡å‹ï¼Œä»¥è¡¥å¿ç‰©ç†æ„ŸçŸ¥çš„ç¼ºå¤±ã€‚

---

## 7. è¿›é˜¶é˜…è¯»
å…³äº ROS é›†æˆã€OOP æ¶æ„è®¾è®¡ä»¥åŠé«˜é¢‘æ§åˆ¶çš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼Œè¯·å‚è€ƒï¼š
ğŸ‘‰ **[ROS é›†æˆä¸ç®—æ³•ä¼˜åŒ– (ROS Integration & Algorithm Optimization)](./ros_and_optimization.md)**

