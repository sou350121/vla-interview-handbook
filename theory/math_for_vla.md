# VLA 數學必備：從直覺到實作（Math for VLA Implementers）

> **目標**：這不是數學系教材，而是「為了能看懂論文、寫出 loss、調好機器人」的最小實踐清單。
> **核心直覺**：深度學習 = 用微積分（優化）去尋找機率（模型）的最優參數；機器人學 = 用線性代數與幾何描述物理移動。

---

## 0. 動作視角：我們在控制什麼？

在 VLA 中，動作輸出通常有兩種主要的數學表示：

- **關節空間（Joint-space, $q$）**：
  - **內容**：直接控制馬達旋轉角度。
  - **優點**：與硬件直接對齊，不用算逆運動學。
  - **數學**：$q \in \mathbb{R}^N$（$N$ 是自由度，如 7 軸臂）。
- **任務空間（Task-space, $x$）**：
  - **內容**：控制末端執行器（TCP）在空間中的位置（$x, y, z$）和姿態。
  - **優點**：符合人類直覺（如「向左移 5cm」），易於泛化。
  - **數學**：$\Delta x \in \mathbb{R}^6$（位置增量 + 歐拉角/旋轉向量增量）。

---

## 1. 線性代數：模型的大腦

### 1.1 內積與相似度（Dot Product）
- **直覺**：兩個向量「長得有多像」？方向越一致，數值越大。
- **公式**：$\text{sim}(A, B) = A \cdot B = \sum A_i B_i$
- **VLA 應用**：**Attention 機制**（Query 與 Key 匹配）、**對齊損失**（圖文/視觸覺對齊）。

### 1.2 矩陣乘法與線性層
- **直覺**：座標變換。把特徵從一個空間「投影」到另一個空間。
- **公式**：$y = Wx + b$
- **VLA 應用**：所有的 MLP 與 Transformer 層。

### 1.3 特徵值與低秩（SVD / LoRA）
- **直覺**：一個矩陣最重要的資訊集中在哪幾個方向？
- **VLA 應用**：**LoRA 微調**。我們假設大模型微調時，參數變化是「低秩」的，只需訓練極小的矩陣。

---

## 2. 微積分與優化：學習的驅動力

### 2.1 鏈式法則（Chain Rule）
- **直覺**：最終的 Loss 發生變化，是前面哪個零件（參數）的責任？
- **VLA 應用**：PyTorch 的 `loss.backward()` 全靠它。

### 2.2 雅可比矩陣（Jacobian）
- **直覺**：輸入變一點點，輸出會變多少？（靈敏度矩陣）。
- **VLA 應用**：**逆運動學（IK）**。要讓手移 1mm，每個關節要轉多少度？

### 2.3 梯度裁剪（Gradient Clipping）
- **直覺**：步子跨太大容易扯到（數值爆炸）。
- **VLA 應用**：訓練 VLA 時，多模態數據容易導致梯度突變，必須限制 $\|g\|_2 < \text{threshold}$。

---

## 3. 機率與損失：衡量「對不對」

### 3.1 負對數似然（NLL）與交叉熵（CE）
- **直覺**：模型預測的機率分佈，與真實標籤有多接近？
- **公式**：$\mathcal{L} = -\log P(\text{target})$
- **VLA 應用**：**Action Token 預測**（分類任務）、**BC 回歸**（高斯假設）。

### 3.2 KL 散度（KL Divergence）
- **直覺**：兩個分佈之間的「距離」。
- **VLA 應用**：**RL 微調**。讓新策略不要跑得離舊策略太遠（KL-to-base penalty）。

### 3.3 重參數化技巧（Reparameterization）
- **直覺**：要在隨機過程中求導？把隨機性（噪聲）挪出來。
- **公式**：$z = \mu + \sigma \cdot \epsilon, \quad \epsilon \sim \mathcal{N}(0, 1)$
- **VLA 應用**：**ACT (CVAE)**、**Diffusion Policy**。

---

## 4. 幾何與變換：物理世界的導航

### 4.1 齊次變換矩陣（SE(3)）
- **直覺**：描述物體在空間中的位置 + 旋轉。
- **格式**：$T = \begin{bmatrix} R & t \\ 0 & 1 \end{bmatrix}$ （$R$ 是 3x3 旋轉，$t$ 是 3x1 位移）。
- **VLA 應用**：**標定**。相機看到的座標 $\to$ 機器人基座座標。

### 4.2 旋轉的表示
- **歐拉角**：直覺（Roll-Pitch-Yaw），但有**萬向節死鎖（Gimbal Lock）**。
- **四元數（Quaternion）**：穩定，但不好理解。
- **6D 旋轉**：VLA 近期流行，因為它在連續空間中表現最穩定（無間斷點）。

---

## 5. 控制與時間：從預測到動作

### 5.1 離散時間與頻率
- **直覺**：機器人不是連續動的，是按幀動的。
- **VLA 應用**：**延遲補償**。預測時要考慮到從感官輸入到動作執行的時間差。

### 5.2 動作平滑（Smoothness / Jerk）
- **直覺**：動作不要一驚一乍，否則會傷電機、引起震動。
- **VLA 應用**：在 Loss 中加入對速度（一階導）和加速度（二階導）的懲罰。

---

## 6. 前沿專題：Diffusion & Flow

### 6.1 擴散模型（Diffusion）
- **直覺**：把「動作生成」想成「洗照片」。從一團亂碼（噪聲）開始，根據環境條件，一步步洗出清晰的動作。
- **核心**：預測噪聲 $\epsilon$。

### 6.2 流匹配（Flow Matching）
- **直覺**：與擴散類似，但它讓噪聲變成動作的路徑是「直線」（最短路徑）。
- **優點**：推理極快（π0 的核心）。

---

## 📅 實踐者 2 週速成清單

- [ ] **Day 1-3**：重溫線性代數矩陣乘法 & 齊次變換（看 `spatial_math.md`）。
- [ ] **Day 4-6**：手推一個高斯 NLL 的 loss 代碼（PyTorch）。
- [ ] **Day 7-9**：理解 PPO 的 Ratio 和 Clip 公式（看 `reinforcement_learning.md`）。
- [ ] **Day 10-12**：畫出 Diffusion 的去噪路徑圖。
- [ ] **Day 13-14**：在模擬器中寫一個帶平滑的正則化 loss 並觀察機械臂動作。

---

[← 返回理論首頁](./README.md)
